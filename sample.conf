# ==================================================================
# WEBSERV CONFIGURATION FILE
# ==================================================================
# Configuration file for the webserv HTTP server project
#
# ADVANCED NGINX FEATURES NOT IMPLEMENTED:
# - try_files directive (complex file resolution)
# - Named locations (@location)
# - Variable substitution ($uri, $args, $request_uri, etc.)
# - Regular expressions in locations (~ and ~*)
# - Conditional statements (if directives)
# - Upstream and load balancing
# - SSL/TLS configuration
# - Proxy pass and reverse proxy
# - Rewrite rules and URL rewriting
# - Access control (allow/deny directives)
# - Rate limiting
# - Gzip compression
# - Cache control headers
# - Worker process configuration
# - Connection limits
# - Custom log formats
# - Virtual host inheritance
# - Include directives for file inclusion
# - Map blocks for variable mapping
# - Geo blocks for IP-based configuration
# - Limit request/connection modules
# - Auth modules (basic/digest authentication)
# - Real IP modules
# - Sub-request authentication
# - FastCGI cache
# - HTTP/2 and HTTP/3 support

# ==================================================================
# DIRECTIVE VALIDATION RULES
# ==================================================================

# ==================================================================
# DIRECTIVE VALIDATION RULES & DEPENDENCIES
# ==================================================================

# listen:
#   - Required: At least one per server block
#   - Format: port | host:port | port1 port2 port3
#   - Validation: Port range 1-65535, valid IP/hostname
#   - Behavior: First server block per host:port is default
#   - Dependencies: NONE (can be first directive)

# server_name:
#   - Optional directive
#   - Format: name1 name2 name3 (space-separated)
#   - Validation: Valid hostnames/domain names
#   - Behavior: First matching name used for routing
#   - Dependencies: NONE (independent directive)

# root:
#   - Required for static file serving
#   - Format: /absolute/path/to/directory
#   - Validation: Must be absolute path, directory must exist and be readable
#   - Behavior: Can be overridden in location blocks
#   - Dependencies: NONE (can be first directive)
#   - PREREQUISITE FOR: error_page paths, index file validation

# index:
#   - Optional, common default: index.html
#   - Format: file1 file2 file3 (space-separated)
#   - Validation: Valid filenames
#   - Behavior: Files checked in order until one exists
#   - Dependencies: REQUIRES root directive for file existence validation
#   - VALIDATION: Index files should exist in root directory (warning if missing)

# autoindex:
#   - Optional, default: off
#   - Format: on | off
#   - Validation: Must be exactly "on" or "off"
#   - Behavior: Shows directory listing when no index file found
#   - Dependencies: NONE (independent directive)

# client_max_body_size:
#   - Optional, default: 1M
#   - Format: number[K|M|G]
#   - Validation: Positive number, valid suffix
#   - Behavior: Returns 413 if request exceeds limit
#   - Dependencies: NONE (independent directive)
#   - LOGICAL RELATION: Most useful with POST methods for uploads

# error_page:
#   - Optional
#   - Format: code1 code2 /path/to/file
#   - Validation: Status codes 400-599, file path relative to root
#   - Behavior: Serves custom error page for specified codes
#   - Dependencies: REQUIRES root directive to be set first
#   - VALIDATION: Error page files must exist in root directory

# allowed_methods (location only):
#   - Required in location blocks
#   - Format: GET POST DELETE (space-separated)
#   - Validation: Only GET, POST, DELETE allowed
#   - Behavior: Returns 405 for non-allowed methods
#   - Dependencies: NONE (can be first in location)
#   - PREREQUISITE FOR: upload_path (needs POST), cgi functionality

# return (location only):
#   - Optional
#   - Format: 301|302 URL
#   - Validation: Status code 301/302, valid URL
#   - Behavior: Stops processing, returns redirect
#   - Dependencies: NONE (independent directive)
#   - MUTUAL EXCLUSION: Cannot coexist with cgi_pass or upload_path

# cgi_path (location only):
#   - Required for CGI processing
#   - Format: /absolute/path/to/executable
#   - Validation: Executable must exist and be executable
#   - Behavior: Executes CGI for matching requests
#   - Dependencies: NONE (can be first in location)
#   - PREREQUISITE FOR: All cgi_param directives
#   - LOGICAL RELATION: Usually paired with GET/POST methods

# cgi_param (location only):
#   - Used with cgi_pass
#   - Format: PARAM_NAME value
#   - Validation: Valid parameter name and value
#   - Behavior: Sets environment variable for CGI process
#   - Dependencies: REQUIRES cgi_pass to be set first
#   - VALIDATION ERROR: cgi_param without cgi_pass is invalid

# upload_path (location only):
#   - Required for file uploads
#   - Format: /absolute/path/to/upload/directory
#   - Validation: Directory must exist and be writable
#   - Behavior: Stores uploaded files in specified directory
#   - Dependencies: REQUIRES POST method in allowed_methods
#   - LOGICAL RELATION: Usually paired with client_max_body_size
#   - VALIDATION ERROR: upload_path without POST method is illogical

# ==================================================================
# CONFIGURATION STRUCTURE RULES & PARSING ORDER
# ==================================================================
# 1. Must have at least one server block
# 2. Server blocks cannot be nested
# 3. Location blocks only inside server blocks
# 4. Directives end with semicolon (;)
# 5. Blocks use curly braces ({ })
# 6. Comments start with #
# 7. Location directives override server directives
# 8. Longest matching location path wins
# 9. All paths must be absolute (start with /)
# 10. Configuration is case-sensitive

# DEPENDENCY VALIDATION RULES:
# - error_page files must be validated AFTER root is set
# - cgi_param directives must come AFTER cgi_pass
# - upload_path should be validated with POST method check
# - return directive conflicts with cgi_pass/upload_path
# - File/directory existence checks happen during validation phase

# RECOMMENDED PARSING ORDER:
# Server Block: listen -> server_name -> root -> other directives -> locations
# Location Block: allowed_methods -> cgi_pass -> cgi_params -> other directives

# ==================================================================
# SERVER CONFIGURATIONS
# ==================================================================

# Basic static file server
server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.html index.htm;
    autoindex off;

    error_page 404 /404.html;
    error_page 500 /50x.html;

    location / {
        allowed_methods GET;
    }
}

# Server with CGI support and file uploads
server {
    listen 8080;
    server_name seayeo.42.fr;
    root /var/www/site;
    index index.php index.html;
    client_max_body_size 10M;

    error_page 404 /404.html;
    error_page 500 /error.html;

    # Static files
    location / {
        allowed_methods GET POST;
    }

    # PHP CGI handling (remove regex ~ syntax - not supported)
    location /cgi-bin/ {
        allowed_methods GET POST;
        cgi_path /usr/bin/php-cgi;
        cgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        cgi_param REQUEST_METHOD $request_method;
        cgi_param CONTENT_TYPE $content_type;
        cgi_param CONTENT_LENGTH $content_length;
    }

    # File upload area
    location /upload/ {
        allowed_methods POST DELETE;
        client_max_body_size 100M;
    }
}

# File server with directory listing
server {
    listen 8081;
    server_name files.example.com;
    root /var/www/files;
    autoindex on;

    error_page 404 /404.html;

    # Downloads with directory listing
    location /downloads/ {
        allowed_methods GET;
        autoindex on;
    }

    # File management
    location /manage/ {
        allowed_methods GET POST DELETE;
        client_max_body_size 50M;
    }
}

# Server with redirects
server {
    listen 8082;
    server_name redirect.example.com;
    root /var/www/redirect;

    # Redirect old URLs
    location /old/ {
        return 301 /new/;
    }

    # Normal content
    location /new/ {
        allowed_methods GET;
    }
}

# Default server (no server_name specified)
server {
    listen 8083;
    root /var/www/default;
    autoindex on;

    location / {
        allowed_methods GET POST DELETE;
    }
}
