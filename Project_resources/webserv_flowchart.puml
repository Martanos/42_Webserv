@startuml WebServ Architecture Flowchart

title WebServ Architecture Flowchart

start

:Logger Init;
:Parse Command Line Args;
if (Invalid Args?) then (yes)
    :Log Error & Exit;
    stop
else (no)
endif

:ConfigParser.parseConfig();
if (Parse Failed?) then (yes)
    :Log Error & Exit;
    stop
else (no)
    :Create ServerConfig Objects;
    :Create LocationConfig Objects;
endif

:Print All Configs (Current Output);

note right: Pseudo-code below - not yet in main.cpp\nActual server launch flow:

:ServerMap (from ServerConfigs);
:Create Server Objects (root, ports, indexes);
:Create Location Objects (URI match, methods, CGI);
:Map ListeningSocket -> Vectors of Servers;

:ServerManager.run();
:Create EpollManager;
:Create ListeningSocket for each port;

while (Server Running)

    :Epoll.wait() for Events;

    if (New Connection on Listen Socket) then (yes)
        :ListeningSocket.accept();
        :Create Client Object;
        :Add Client FD to Epoll (EPOLLIN);
    else (no)
    endif

    if (Client Event) then (yes)
        :Client.handleEvent();

        if (Reading Request) then (yes)
            :RingBuffer: Buffer Data;
            :HttpURI.parse(Request Line);
            :HttpHeaders.parse(Headers);
            :HttpBody.parse(Body if any);
            :Create HttpRequest Object;

            :Client._identifyServer();
            :Client._processHTTPRequest();
            :RequestRouter.route Request;
            :matchLocation() for URI;
            :Check Method Allowed;

            switch (HTTP Method)
                case (GET)
                    :GetMethodHandler.handle();
                    if (Static File?) then (yes)
                        :Serve File or Directory Listing;
                    endif
                    if (CGI?) then (yes)
                        :CgiHandler.execute();
                        :CgiEnv: Set Environment Vars;
                        :CgiExecutor: Fork & Execute;
                        :CgiResponse: Parse Output;
                    endif

                case (POST)
                    :PostMethodHandler.handle();
                    if (File Upload) then (yes)
                        :Handle File Upload;
                    else (CGI)
                        :Execute CGI;
                    endif

                case (DELETE)
                    :DeleteMethodHandler.handle();
                    :Delete File (if allowed);

                case (Other)
                    :Generate 405 Method Not Allowed;
            endswitch

            :Create HttpResponse;
            :Set Status, Headers, Body;

        else (Sending Response)
            :Client.sendResponse();
            :Write to Client Socket;
        endif
    else (no)
    endif

    if (Timeout) then (yes)
        :Check Client Timeouts;
        :Remove Timed Out Clients;
    endif

endwhile

:Server Shutdown;
stop

@enduml
